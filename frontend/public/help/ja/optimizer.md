# オプティマイザー ステップガイド

Ads.txt Manager オプティマイザーで利用可能な各最適化ステップについて解説します。

<a id="step1"></a>

## 1. エラーと重複のクリーンアップ (Clean Up Errors & Duplicates)

このステップでは、ads.txtファイル内の構文エラーの修正と冗長なエントリの削除を行い、ファイルを有効かつ簡潔な状態にします。

### 機能:
このステップで検出・修正される主な問題：

#### **フォーマットエラー**
IAB仕様に従っていない行を特定します：
- **カンマの入れ忘れ**: フィールド間の区切りカンマが欠落している
- **全角文字の混入**: 全角カンマや全角スペースの使用
- **余分な空白・改行**: 不要な空白文字や改行
- **無効な文字**: 使用禁止文字や制御文字の混入
- **フィールド数の不一致**: 必須フィールドの欠落または過剰

#### **重複エントリ**
同一内容の重複行を検出します：
- 完全に一致する行（ドメイン、アカウントID、関係性、認証局IDがすべて同じ）
- 重複した変数ディレクティブ（OWNERDOMAIN、MANAGERDOMAINなど）

#### **フォーマット正規化 (Format Normalization)**
形式のゆらぎを統一し、可読性とパース精度を向上させます：
- **大文字小文字の統一**: DIRECT/RESELLERを大文字に、ドメイン名を小文字に統一
- **改行コードの統一**: CRLF/CRをLFに統一
- **余分な空行の削除**: 連続する空行を1行に、ファイル末尾の空行を削除
- **スペースの正規化**: カンマ後のスペースを統一（`, ` 形式）

### チェックポイント:
- ✅ 各行が規定のフィールド数・順序になっているか
- ✅ カンマ区切りの位置やスペルに誤りがないか
- ✅ DIRECT と RESELLER の綴りが正しいか
- ✅ アカウントIDが正確か（パートナーから提供された情報と一致するか）

### 推奨アクション:

#### **無効な行の処理**
- **削除 (Remove)**: 無効な行を完全に削除します（クリーンなファイルを維持）
- **コメントアウト (Comment Out)**: `# INVALID:` プレフィックスを追加して行を無効化します（監査や後で確認したい場合に便利）

#### **重複行の処理**
- **削除 (Remove)**: 重複行を削除して1つだけ残します
- **コメントアウト (Comment Out)**: `# DUPLICATE:` プレフィックスを追加して重複を明示します

#### **フォーマット正規化の適用**
- **有効 (Enable)**: 「フォーマットの正規化」オプションをオンにすると、既存のコメントや行の順序を保持したまま、フォーマットのみを綺麗に整えます

### よくあるエラー例:
```
# エラー例1: カンマ欠落
google.com pub-1234567890 DIRECT f08c47fec0942fa0

# エラー例2: 全角文字混入
google.com、pub-1234567890、DIRECT、f08c47fec0942fa0

# エラー例3: スペルミス
google.com, pub-1234567890, DIRRECT, f08c47fec0942fa0
```

---

<a id="step2"></a>

## 2. オーナードメインの確認 (Check Owner Domain)

ads.txtファイルにOWNERDOMAINディレクティブを追加し、サイトやアプリの実際の所有者（ビジネスエンティティ）を明示的に宣言します。

### 機能:
- `OWNERDOMAIN={domain}` が存在するかチェックします。
- 欠落している場合、自動的に追加します。
- **重要**: OWNERDOMAINを明示的に指定しない場合、ads.txtを配置したドメイン（ルートドメイン）がデフォルトでOWNERDOMAINとして扱われます。

### OWNERDOMAINの役割:
- **Sellers.jsonとの照合**: OWNERDOMAINは、Sellers.jsonファイル内のPUBLISHERまたはBOTHとして登録されているセラーのドメインと照合されます。
- **複数ドメインの統合**: 複数のドメインを所有している場合でも、同じ事業者に属していればすべてのドメインで同じOWNERDOMAINを指定できます。
- **透明性の向上**: たとえads.txtを配置したドメインと同じ場合でも、明示的に指定することでサプライチェーンの透明性が向上します。

### 使用例:
```
OWNERDOMAIN=example-publisher.com
google.com, pub-1234567890, DIRECT, f08c47fec0942fa0
```

---

<a id="step3"></a>

## 3. マネージャードメインの検証 (Verify Manager Domain)

パブリッシャーが広告収益化を外部委託している場合、MANAGERDOMAINエントリを検証し、適切に管理します。

### 機能:
- `MANAGERDOMAIN=` エントリを検出します。
- 無効または不要なMANAGERDOMAINエントリを削除またはコメントアウトします。

### MANAGERDOMAINとは:
- **役割**: パブリッシャーの広告収益化を管理する事業者（販売代理店やセールスハウスなど）を示します。
- **使用条件**: パブリッシャーが**大部分のインベントリ管理を外部に委託している場合のみ**使用すべきです。
- **注意**: 一部の広告フォーマットのみを管理する場合には使用を避けましょう。

### 地域別管理:
- **グローバル管理**: 国コードなしで指定（例: `MANAGERDOMAIN=global-sales.com`）
- **地域別管理**: 2文字のISO国コードを追加（例: `MANAGERDOMAIN=eu-sales.com, EU`）
- **制限**: 同じ国に複数のMANAGERDOMAINを設定するとエラーになります。

### 使用例:
```
OWNERDOMAIN=example-publisher.com
MANAGERDOMAIN=global-sales.com
MANAGERDOMAIN=eu-sales.com, EU
google.com, pub-1234567890, DIRECT, f08c47fec0942fa0
```

### 推奨アクション:
- MANAGERDOMAINを使用していない、または不要な場合は削除してください。
- Sellers.jsonとの整合性を保つため、MANAGERDOMAINが正しく設定されているか確認してください。

---

<a id="step4"></a>

## 4. リレーションシップの修正 (Relationship Correction)

広告システムの `sellers.json` データに基づいて、ads.txtエントリの関係性フィールド（`DIRECT` / `RESELLER`）を自動的に修正します。

### 機能:
このステップでは、Ads.txt Managerに保存されている各広告システムのsellers.jsonデータを使用して、関係性の妥当性を検証し、必要に応じて自動修正します。

#### **検証プロセス**:
1. ads.txt内の各エントリ（ドメイン + アカウントID）を抽出
2. 対応するsellers.jsonファイル内のエントリを検索
3. sellers.json内の `seller_type` フィールドを確認
4. ads.txtの関係性フィールドと照合

#### **自動修正ルール**:
| sellers.jsonの seller_type | 正しい ads.txt 関係性 |
|---------------------------|---------------------|
| `PUBLISHER` | `DIRECT` |
| `BOTH` | `DIRECT` または `RESELLER` |
| `INTERMEDIARY` | `RESELLER` |

### 修正例:
```
# 修正前（誤り）
google.com, pub-1234567890, RESELLER, f08c47fec0942fa0

# sellers.jsonを確認
# → seller_type = "PUBLISHER" と判明

# 修正後（正）
google.com, pub-1234567890, DIRECT, f08c47fec0942fa0
```

### 重要性:
- **収益への影響**: 関係性の不一致は、DSP（需要側プラットフォーム）による入札除外や収益損失につながる可能性があります
- **透明性の確保**: 正確な関係性宣言は、サプライチェーンの透明性向上に不可欠です
- **プラットフォームからの警告回避**: Google AdSenseなどの広告プラットフォームから警告を受けるリスクを軽減します

### 注意事項:
- このステップは、Ads.txt Managerのデータベースに保存されているsellers.jsonデータを使用します
- データベースに該当するsellers.jsonが存在しない場合、検証はスキップされます
- 修正は、sellers.jsonに明確に記載されている情報に基づいてのみ行われます

---

<a id="step5"></a>

## 5. セラーの検証 (Verify Sellers)

ads.txtに記載されているセラーID（アカウントID）が、実際に広告システムの `sellers.json` ファイルに存在するかを検証し、無効なエントリを特定します。

### 機能:
このステップでは、Ads.txt Managerのデータベースに保存されているsellers.jsonデータを使用して、ads.txtエントリの妥当性を検証します。

#### **検証プロセス**:
1. ads.txt内の各エントリ（広告システムのドメイン + アカウントID）を抽出
2. Ads.txt Managerのsellers_catalogテーブルで該当エントリを検索
3. **存在しない場合**: そのセラーIDは無効または非アクティブである可能性が高い
4. **存在する場合**: セラーIDは有効（このステップではアクションなし）

### 無効なセラーIDの原因:
- **アカウントの閉鎖**: 過去に使用していたが、現在は無効になっているアカウント
- **IDの誤記載**: パートナーから提供されたIDの入力ミス
- **古い情報**: パートナーがsellers.jsonを更新し、該当IDを削除した
- **テストアカウント**: テスト用のIDが本番環境に残っている

### 検証例:
```
# ads.txt内のエントリ
appnexus.com, 12345, DIRECT

# sellers.jsonを確認
# → appnexus.comのsellers.jsonに「12345」が存在しない

# 判定: 無効なセラーID
```

### 推奨アクション:

#### **無効なエントリの処理**
- **削除 (Remove)**: セラーIDが存在しない場合、その行を完全に削除します（推奨）
  - 無効な行を削除することで、ファイルをクリーンに保ち、広告システムの処理を効率化します

- **コメントアウト (Comment Out)**: `# INVALID_SELLER_ID:` プレフィックスを追加して無効化します
  - 監査や記録のために履歴を残したい場合に有用です
  - 後でパートナーに確認する際の参考資料として保持できます

### 重要性:
- **ファイルの信頼性向上**: 有効なセラーのみを含むads.txtは、広告システムからの信頼性が高まります
- **処理の効率化**: 無効なエントリを削除することで、広告システムのクロール処理が効率化されます
- **警告の回避**: 無効なセラーIDは、一部の広告プラットフォームで警告の原因となる場合があります

### 注意事項:
- このステップは、Ads.txt Managerのデータベースに保存されているsellers.jsonデータに基づきます
- データベースに該当するsellers.jsonが存在しない場合、検証はスキップされます
- セラーIDが見つからない場合は、削除前にパートナーに確認することを推奨します

---

<a id="step6"></a>

## 6. 認証局IDの検証 (Verify Certification Authority ID)

広告システムのドメインに基づいて、ads.txtエントリの4番目のフィールド（認証局ID / Certification Authority ID）を検証し、誤っている場合に自動的に修正します。

### 機能:
認証局ID（TAG IDなど）は、広告システムごとに固定の値が決まっていますが、しばしば入力ミスやコピー＆ペーストの誤りが発生します。
このステップでは、既知の正しい認証局IDリスト（Google, OpenX, PubMaticなど主要SSP）と照合し、修正します。

### 検証プロセス:
1. ads.txtの各行からドメイン（第1フィールド）を読み取る
2. そのドメインに対応する正しい認証局IDをデータベースから取得
3. ads.txtの第4フィールドと比較
4. 一致しない場合、または欠落している場合に正しいIDで上書き・追記

### 修正例:
```
# 修正前（誤りまたは欠落）
google.com, pub-1234567890, DIRECT, incorrect-id
google.com, pub-1234567890, DIRECT

# DB照合
# google.com の正しいID = f08c47fec0942fa0

# 修正後（正）
google.com, pub-1234567890, DIRECT, f08c47fec0942fa0
google.com, pub-1234567890, DIRECT, f08c47fec0942fa0
```

### 重要性:
- **信頼性の向上**: 正しい認証局IDを持つことで、Trustworthy Accountability Group (TAG) などの業界標準に基づいた信頼性を証明できます。
- **エラー削減**: 人為的なミスによるIDの不一致を自動的に解消します。

### 注意事項:
- Ads.txt Managerがデータベースに保有している主要な広告システムのIDのみが対象です。
- マイナーなSSPや独自のシステムの場合、検証対象外となることがあります。

